<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>FastAPI Auth Pro</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        max-width: 600px;
        margin: 40px auto;
        background-color: #eef2f7;
        color: #333;
      }
      .box {
        border: none;
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 20px;
        background: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }
      h3 {
        margin-top: 0;
        color: #2c3e50;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
      }
      h4 {
        margin-bottom: 10px;
        color: #555;
      }
      input {
        display: block;
        width: 100%;
        margin: 12px 0;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-sizing: border-box;
      }
      button {
        padding: 12px;
        cursor: pointer;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        width: 100%;
        font-weight: bold;
        transition: 0.3s;
      }
      button:hover {
        background: #0056b3;
        transform: translateY(-1px);
      }
      #resultado {
        background: #2d3436;
        color: #dfe6e9;
        padding: 15px;
        border-radius: 6px;
        overflow-x: auto;
        font-size: 0.9em;
      }
      .admin-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 0.85em;
      }
      .admin-table th,
      .admin-table td {
        border: 1px solid #eee;
        padding: 10px;
        text-align: left;
      }
      .admin-table th {
        background: #f8f9fa;
      }
      .status-bloqueado {
        color: #d9534f;
        font-weight: bold;
      }
      .status-ok {
        color: #28a745;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="box">
      <h3>Login</h3>
      <input type="email" id="email" placeholder="E-mail" />
      <input type="password" id="senha" placeholder="Senha" />
      <button onclick="fazerLogin()">Entrar</button>
    </div>

    <div class="box">
      <h3>Área do Usuário</h3>
      <button onclick="acessarHome()" style="background: #17a2b8">
        Acessar Rota Protegida
      </button>

      <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee" />

      <h4>Alterar Senha (Logado)</h4>
      <input
        type="password"
        id="perfil-senha-atual"
        placeholder="Senha Atual"
      />
      <input type="password" id="perfil-nova-senha" placeholder="Nova Senha" />
      <input
        type="password"
        id="perfil-conf-senha"
        placeholder="Repita a Nova Senha"
      />
      <button onclick="trocarSenhaPerfil()" style="background: #28a745">
        Atualizar Minha Senha
      </button>

      <button
        onclick="fazerLogout()"
        style="background: #dc3545; margin-top: 20px"
      >
        Sair de Todas as Sessões
      </button>
      <p>Resposta da API:</p>
      <pre id="resultado">Nenhum dado carregado.</pre>
    </div>

    <div class="box" style="border-left: 5px solid #6f42c1">
      <h3>Painel do Administrador</h3>
      <button onclick="carregarUsuarios()" style="background: #6f42c1">
        Listar Todos os Usuários
      </button>
      <div id="painel-admin"></div>
    </div>

    <div class="box">
      <h3>Criar Conta</h3>
      <input type="email" id="reg-email" placeholder="E-mail" />
      <input
        type="password"
        id="reg-senha"
        placeholder="Senha (Maiúscula, Minúscula, Número, Especial)"
      />
      <button onclick="fazerRegistro()" style="background: #28a745">
        Cadastrar Novo Usuário
      </button>
    </div>

    <div class="box">
      <h3>Recuperação de Senha</h3>
      <input type="email" id="rec-email" placeholder="Digite seu e-mail" />
      <button onclick="pedirRecuperacao()" style="background: #6c757d">
        Enviar Token para Console
      </button>

      <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee" />

      <h4>Redefinir Agora</h4>
      <input
        type="text"
        id="reset-token"
        placeholder="Cole o Token do VS Code aqui"
      />
      <input type="password" id="nova-senha" placeholder="Nova Senha" />
      <input
        type="password"
        id="confirmar-senha"
        placeholder="Repita a Nova Senha"
      />

      <button
        onclick="finalizarReset()"
        style="background: #ffc107; color: #212529"
      >
        Salvar Nova Senha
      </button>
    </div>

    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/toastify-js"
    ></script>
    <script>
      const API_URL = "http://127.0.0.1:8000";

      function avisar(msg, cor = "#007bff") {
        let textoFinal = msg;
        if (Array.isArray(msg)) {
          textoFinal = msg[0].msg;
        }
        Toastify({
          text: textoFinal,
          duration: 5000,
          gravity: "top",
          position: "right",
          style: { background: cor },
        }).showToast();
      }

      async function fazerRegistro() {
        const email = document.getElementById("reg-email").value;
        const senha = document.getElementById("reg-senha").value;
        const response = await fetch(`${API_URL}/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, senha }),
        });
        const data = await response.json();
        if (response.ok) avisar("Conta criada! Tente logar.", "#28a745");
        else avisar(data.detail, "#d9534f");
      }

      async function fazerLogin() {
        const formData = new FormData();
        formData.append("username", document.getElementById("email").value);
        formData.append("password", document.getElementById("senha").value);

        const response = await fetch(`${API_URL}/login`, {
          method: "POST",
          body: formData,
          credentials: "include",
        });

        const data = await response.json();
        if (response.ok)
          avisar("Bem-vindo! Cookie de sessão salvo.", "#28a745");
        else avisar(data.detail, "#d9534f");
      }

      async function acessarHome() {
        const response = await fetch(`${API_URL}/home`, {
          method: "GET",
          credentials: "include",
        });
        const data = await response.json();
        document.getElementById("resultado").innerText = JSON.stringify(
          data,
          null,
          2,
        );
        if (!response.ok) avisar(data.detail || "Acesso negado!", "#d9534f");
      }

      // --- NOVA FUNÇÃO: TROCAR SENHA LOGADO ---
      async function trocarSenhaPerfil() {
        const senha_atual = document.getElementById("perfil-senha-atual").value;
        const nova_senha = document.getElementById("perfil-nova-senha").value;
        const confirmar_nova_senha =
          document.getElementById("perfil-conf-senha").value;

        const response = await fetch(`${API_URL}/trocar-senha-perfil`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            senha_atual,
            nova_senha,
            confirmar_nova_senha, // Nome deve bater com o Schemas.py
          }),
          credentials: "include",
        });

        const data = await response.json();
        if (response.ok) {
          avisar("Senha alterada! Relogue por segurança.", "#28a745");
          setTimeout(() => location.reload(), 2000);
        } else {
          avisar(data.detail, "#d9534f");
        }
      }

      async function carregarUsuarios() {
        const response = await fetch(`${API_URL}/admin/users`, {
          method: "GET",
          credentials: "include",
        });
        const data = await response.json();
        if (!response.ok) {
          avisar(data.detail, "#d9534f");
          return;
        }

        let html = `<table class="admin-table"><tr><th>Email</th><th>Cargo</th><th>Status</th></tr>`;
        data.forEach((u) => {
          const status = u.bloqueado
            ? '<span class="status-bloqueado">Bloqueado</span>'
            : '<span class="status-ok">Ativo</span>';
          html += `<tr><td>${u.email}</td><td>${u.role}</td><td>${status}</td></tr>`;
        });
        document.getElementById("painel-admin").innerHTML = html + `</table>`;
      }

      async function fazerLogout() {
        await fetch(`${API_URL}/logout`, {
          method: "POST",
          credentials: "include",
        });
        avisar("Sessão encerrada.");
        setTimeout(() => location.reload(), 1500);
      }

      async function pedirRecuperacao() {
        const email = document.getElementById("rec-email").value;
        await fetch(`${API_URL}/esqueci-minha-senha`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email }),
        });
        avisar("Verifique o terminal do VS Code!", "#6c757d");
      }

      async function finalizarReset() {
        const token = document.getElementById("reset-token").value;
        const nova_senha = document.getElementById("nova-senha").value;
        const confirmar_senha =
          document.getElementById("confirmar-senha").value;

        const response = await fetch(`${API_URL}/resetar-senha`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, nova_senha, confirmar_senha }),
        });

        const data = await response.json();
        if (response.ok) {
          avisar("Senha alterada!", "#28a745");
          document
            .querySelectorAll(".box input")
            .forEach((i) => (i.value = ""));
        } else {
          avisar(data.detail, "#d9534f");
        }
      }
    </script>
  </body>
</html>
